<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rutin Takip</title>
    
    <!-- K√ºt√ºphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { 
            font-family: 'Helvetica', 'Arial', sans-serif; 
            background-color: #fce4ec; 
            -webkit-tap-highlight-color: transparent;
        }
        .btn-press:active { transform: scale(0.95); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #ff80ab; border-radius: 3px; }
        .icon-select { 
            -webkit-appearance: none; appearance: none; text-align: center; text-align-last: center;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="app" class="flex flex-col min-h-screen max-w-md mx-auto bg-white shadow-2xl relative overflow-hidden">

    <!-- Y√úKLENƒ∞YOR UYARISI -->
    <div v-if="loading" class="absolute inset-0 z-[60] flex flex-col items-center justify-center bg-white/90 backdrop-blur-sm">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-pink-500 mb-3"></div>
        <p class="text-pink-600 font-bold animate-pulse">Veriler E≈üitleniyor...</p>
    </div>

    <!-- KAR≈ûILAMA EKRANI -->
    <transition name="fade">
        <div v-if="showWelcome" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-br from-pink-100 to-green-100 text-center p-6">
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-xl border-4 border-white animate-bounce-slow">
                <div class="text-6xl mb-6">üëë</div>
                <h1 class="text-3xl font-extrabold text-pink-500 mb-8 tracking-tight">Ho≈ü Geldin!</h1>
                <button @click="showWelcome = false" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold text-xl py-4 rounded-2xl shadow-lg transition transform hover:scale-105 btn-press">
                    <i class="fas fa-star text-yellow-300 mr-2"></i> Ba≈ülayalƒ±m!
                </button>
            </div>
        </div>
    </transition>

    <!-- √úST BAR -->
    <header class="bg-pink-400 p-4 pb-2 text-white shadow-md z-10 transition-all duration-300" :class="{'bg-purple-600': editMode, 'bg-gray-800': isAdmin}">
        
        <!-- MOD Bƒ∞LGƒ∞LENDƒ∞RME -->
        <div v-if="editMode" class="bg-yellow-300 text-yellow-900 text-xs font-bold text-center py-1 rounded mb-2 animate-pulse">
            D√úZENLEME MODU A√áIK
        </div>
        <div v-if="isAdmin" class="bg-red-500 text-white text-xs font-bold text-center py-1 rounded mb-2">
            Y√ñNETƒ∞Cƒ∞ Gƒ∞Rƒ∞≈ûƒ∞ YAPILDI üîì
        </div>

        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-16 h-16 rounded-full border-4 border-white bg-white/20 overflow-hidden shadow-sm relative group cursor-pointer flex items-center justify-center" @click="triggerFileUpload">
                    <img v-if="profileImage" :src="profileImage" class="w-full h-full object-cover">
                    <i v-else class="fas fa-camera text-2xl text-white/80"></i>
                </div>
                <div class="flex-1">
                    <input v-if="editMode" v-model="appTitle" class="bg-white/20 border border-white/50 rounded p-1 text-white font-bold w-full" placeholder="ƒ∞sim Giriniz...">
                    <h1 v-else class="text-xl font-bold leading-tight">{{ appTitle }}</h1>
                    <p class="text-xs opacity-90 font-medium">‚ú® Hedeflerine ula≈ü!</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <!-- Y√∂netici Butonu -->
                <button @click="toggleAdminLogin" :class="isAdmin ? 'bg-red-500' : 'bg-white/20'" class="p-3 rounded-full w-10 h-10 flex items-center justify-center transition text-white">
                    <i class="fas" :class="isAdmin ? 'fa-unlock' : 'fa-lock'"></i>
                </button>
                <!-- Aray√ºz D√ºzenle Butonu -->
                <button @click="toggleEditMode" :class="editMode ? 'bg-green-400 text-white shadow-lg scale-110' : 'bg-white/20 text-white'" class="p-3 rounded-full w-10 h-10 flex items-center justify-center transition">
                    <i class="fas" :class="editMode ? 'fa-save' : 'fa-pen'"></i>
                </button>
            </div>
        </div>
        
        <!-- HAFTALIK TAKVƒ∞M -->
        <div class="flex justify-between items-center bg-white/10 p-2 rounded-xl backdrop-blur-sm mb-2">
            <button @click="changeWeek(-1)" class="p-2 hover:bg-white/20 rounded-full"><i class="fas fa-chevron-left"></i></button>
            <div class="flex gap-1 overflow-x-auto no-scrollbar">
                <div v-for="day in weekDays" :key="day.dateStr" 
                     @click="selectDate(day.dateObj)"
                     :class="isSelected(day.dateObj) ? 'bg-white text-pink-500 transform scale-110 shadow-md' : 'text-white hover:bg-white/20'"
                     class="flex flex-col items-center justify-center w-10 h-12 rounded-lg cursor-pointer transition-all">
                    <span class="text-[10px] font-bold opacity-80">{{ day.name }}</span>
                    <span class="text-sm font-bold">{{ day.num }}</span>
                </div>
            </div>
            <button @click="changeWeek(1)" class="p-2 hover:bg-white/20 rounded-full"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- SE√áƒ∞Lƒ∞ TARƒ∞H -->
        <div class="flex items-center justify-center gap-3 bg-black/10 py-1 rounded mt-1 relative">
            <span class="text-xs font-bold">Se√ßili: {{ formatDateDisplay(selectedDate) }}</span>
            <div class="relative w-6 h-6 cursor-pointer">
                <i class="fas fa-calendar-alt text-lg text-white absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></i>
                <input type="date" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-20" @change="onManualDateChange">
            </div>
        </div>
    </header>

    <!-- SEKMELER -->
    <div class="flex p-2 gap-2 bg-pink-50 sticky top-0 z-40">
        <button @click="activeTab = 'rutin'" 
                :class="activeTab === 'rutin' ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-pink-400 border border-pink-100'"
                class="flex-1 py-3 rounded-xl font-bold transition-all btn-press flex items-center justify-center gap-2">
            <i class="fas fa-heart"></i> Rutin
        </button>
        <button @click="activeTab = 'ders'" 
                :class="activeTab === 'ders' ? 'bg-green-500 text-white shadow-lg' : 'bg-white text-green-500 border border-green-100'"
                class="flex-1 py-3 rounded-xl font-bold transition-all btn-press flex items-center justify-center gap-2">
            <i class="fas fa-book-open"></i> Ders
        </button>
    </div>

    <!-- ƒ∞√áERƒ∞K -->
    <main class="flex-1 overflow-y-auto p-4 bg-gray-50 pb-20">
        <div v-if="activeTab === 'rutin'" class="space-y-6">
            <div class="grid grid-cols-2 gap-3">
                <div v-for="(act, index) in activities" :key="act.id" class="relative group animate-slide-up" :style="{ animationDelay: index * 50 + 'ms' }">
                    <button v-if="editMode" @click="removeActivity(index)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center z-20 shadow-md">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                    <div :class="act.color" class="w-full p-3 rounded-2xl shadow-sm border-b-4 border-black/5 flex flex-col items-center justify-center h-32 relative transition-all">
                        <div v-if="editMode" class="mb-1 w-full flex justify-center">
                            <select v-model="act.icon" class="bg-white/50 border border-gray-300 text-gray-700 text-sm rounded p-1 w-3/4 icon-select">
                                <option v-for="icon in iconOptions" :value="icon.val">{{ icon.label }}</option>
                            </select>
                        </div>
                        <button v-else @click="openActivityModal(act)" class="bg-white/40 w-12 h-12 flex items-center justify-center rounded-full mb-2 text-gray-700 text-2xl btn-press">
                            <i :class="['fas', act.icon]"></i>
                        </button>
                        <div v-if="editMode" class="w-full flex justify-center mb-1">
                            <select v-model="act.color" class="bg-white/50 border border-gray-300 text-xs rounded p-1 w-3/4">
                                <option value="bg-pink-200">Pembe</option>
                                <option value="bg-blue-200">Mavi</option>
                                <option value="bg-green-200">Ye≈üil</option>
                                <option value="bg-yellow-200">Sarƒ±</option>
                                <option value="bg-purple-200">Mor</option>
                                <option value="bg-orange-200">Turuncu</option>
                            </select>
                        </div>
                        <input v-if="editMode" v-model="act.label" class="w-full text-center text-xs bg-white font-bold rounded p-1 border border-gray-300 text-gray-800" />
                        <span v-else class="font-bold text-gray-700 text-sm text-center leading-tight px-1 cursor-pointer" @click="openActivityModal(act)">{{ act.label }}</span>
                        <div v-if="!editMode && getDayActivityTotal(act.id) > 0" class="absolute top-2 right-2 bg-white/90 text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm pointer-events-none">
                            {{ getDayActivityTotal(act.id) }} dk
                        </div>
                    </div>
                </div>
                <button v-if="editMode" @click="addNewActivity" class="border-2 border-dashed border-gray-300 text-gray-400 bg-gray-50 rounded-2xl flex flex-col items-center justify-center h-32 hover:bg-gray-100 transition">
                    <i class="fas fa-plus text-3xl mb-2"></i>
                    <span class="font-bold text-sm">Yeni Ekle</span>
                </button>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-md border border-pink-100">
                <h3 class="font-bold text-pink-500 mb-4 flex items-center gap-2"><i class="fas fa-chart-pie"></i> G√ºnl√ºk Daƒüƒ±lƒ±m</h3>
                <div class="h-48 relative">
                    <canvas id="rutinChart"></canvas> 
                    <div v-if="dailyActivities.length === 0" class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm italic">Veri yok</div>
                </div>
            </div>
            <div class="space-y-2">
                <div v-for="log in dailyActivities" :key="log.id" class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-500">
                            <i :class="['fas', getActivityIcon(log.type)]"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-700 text-sm">{{ getActivityLabel(log.type) }}</div>
                            <div class="text-xs text-gray-400">{{ log.minutes }} dk <span v-if="log.pages">‚Ä¢ {{ log.pages }} Syf</span></div>
                        </div>
                    </div>
                    <!-- Y√ñNETƒ∞Cƒ∞ BUTONLARI -->
                    <div v-if="isAdmin" class="flex gap-2">
                        <button @click="editLog(log, 'activity')" class="text-blue-400 hover:text-blue-600 p-2 bg-blue-50 rounded-lg">
                            <i class="fas fa-edit"></i>
                        </button>
                        <!-- Sƒ±fƒ±rlama (Silme) Butonu -->
                        <button @click="editLog(log, 'activity_delete')" class="text-red-400 hover:text-red-600 p-2 bg-red-50 rounded-lg" title="Silmek i√ßin d√ºzenleyip 0 yapƒ±n">
                             <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div v-if="activeTab === 'ders'" class="space-y-6">
            <div class="bg-white p-5 rounded-3xl shadow-md border-t-4 border-green-500 relative">
                <h3 class="font-bold text-green-700 mb-4 flex items-center gap-2">
                    <i class="fas fa-clipboard-check"></i> 
                    {{ editingId ? 'Kaydƒ± D√ºzenle' : 'Test Sonucu Gir' }}
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">Ders Se√ß</label>
                        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                            <button v-for="subj in subjects" :key="subj" @click="newTest.subject = subj" :class="newTest.subject === subj ? 'bg-green-500 text-white shadow-md' : 'bg-gray-100 text-gray-500'" class="px-3 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition">{{ subj }}</button>
                            <button v-if="editMode" @click="addSubject" class="px-3 py-2 rounded-lg text-sm font-bold bg-yellow-100 text-yellow-600 border border-yellow-300">+ Ekle</button>
                        </div>
                    </div>
                    <div v-if="editMode" class="bg-yellow-50 p-2 rounded border border-yellow-200">
                        <p class="text-xs font-bold text-yellow-600 mb-2">Dersleri D√ºzenle:</p>
                        <div class="flex flex-wrap gap-2">
                            <div v-for="(subj, i) in subjects" :key="i" class="flex items-center bg-white border rounded px-2 py-1 text-xs">
                                <input v-model="subjects[i]" class="w-20 outline-none">
                                <button @click="removeSubject(i)" class="ml-2 text-red-500 font-bold">x</button>
                            </div>
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">Toplam Soru</label><input type="number" v-model="newTest.total" class="w-full p-3 rounded-xl border-2 border-gray-200 text-center font-bold text-lg focus:border-green-500 outline-none" placeholder="20"></div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="text-xs font-bold text-green-500 block mb-1 text-center">Doƒüru</label><input type="number" v-model="newTest.correct" class="w-full p-3 rounded-xl border-2 border-green-100 text-green-600 text-center font-bold outline-none" placeholder="0"></div>
                        <div><label class="text-xs font-bold text-yellow-500 block mb-1 text-center">Bo≈ü</label><input type="number" v-model="newTest.empty" class="w-full p-3 rounded-xl border-2 border-yellow-100 text-yellow-600 text-center font-bold outline-none" placeholder="0"></div>
                        <div><label class="text-xs font-bold text-red-500 block mb-1 text-center">Yanlƒ±≈ü</label><div class="w-full p-3 rounded-xl bg-red-50 border-2 border-red-100 text-red-500 text-center font-bold">{{ calculateWrong }}</div></div>
                    </div>
                    <div class="flex gap-2">
                        <button v-if="editingId" @click="cancelEdit" class="w-1/3 bg-gray-300 text-gray-700 font-bold py-3 rounded-xl shadow-lg btn-press mt-2">ƒ∞PTAL</button>
                        <button @click="saveTest" :disabled="!isValidTest" class="flex-1 bg-green-500 disabled:bg-gray-300 text-white font-bold py-3 rounded-xl shadow-lg btn-press mt-2">
                            {{ editingId ? 'G√úNCELLE' : 'KAYDET' }}
                        </button>
                    </div>
                    <p v-if="editingId" class="text-xs text-center text-red-500 font-bold">‚ö†Ô∏è Silmek i√ßin Toplam Soru'yu 0 yapƒ±p g√ºncelleyin.</p>
                </div>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-md border border-green-100">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-green-600 flex items-center gap-2"><i class="fas fa-chart-line"></i> Ba≈üarƒ± Grafiƒüi</h3><select v-model="chartSubject" class="text-xs border rounded p-1"><option value="all">Genel</option><option v-for="s in subjects" :value="s">{{s}}</option></select></div>
                <div class="h-48 relative"><canvas id="dersChart"></canvas><div v-if="filteredRecords.length === 0" class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm italic">Kayƒ±t yok</div></div>
            </div>
            <div class="space-y-2">
                <div v-for="record in dailyTests" :key="record.id" class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                    <div><div class="font-bold text-gray-700 text-sm">{{ record.subject }}</div><div class="text-xs text-gray-400">{{ record.total }} Soru</div></div>
                    <div class="flex gap-2"><span class="px-2 py-1 bg-green-100 text-green-600 rounded text-xs font-bold">D:{{record.correct}}</span><span class="px-2 py-1 bg-yellow-100 text-yellow-600 rounded text-xs font-bold">B:{{record.empty}}</span><span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs font-bold">Y:{{record.wrong}}</span></div>
                    
                    <!-- Y√ñNETƒ∞Cƒ∞ BUTONLARI -->
                    <div v-if="isAdmin" class="flex gap-2 ml-2">
                        <button @click="editLog(record, 'test')" class="text-blue-400 hover:text-blue-600 p-2 bg-blue-50 rounded-lg">
                            <i class="fas fa-edit"></i>
                        </button>
                        <!-- Sƒ±fƒ±rlama (Silme) Butonu -->
                        <button @click="editLog(record, 'test_delete')" class="text-red-400 hover:text-red-600 p-2 bg-red-50 rounded-lg" title="Silmek i√ßin d√ºzenleyip 0 yapƒ±n">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Aktivite Modalƒ± -->
    <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-3xl w-full max-w-sm relative animate-slide-up shadow-2xl border-4 border-pink-200">
            <button @click="showModal = false; editingId = null;" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-2"><i :class="['fas', currentActivity?.icon, 'text-pink-400']"></i> {{ currentActivity?.label }}</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">S√ºre (Dakika)</label><input type="number" v-model="modalMinutes" autofocus class="w-full text-center text-4xl font-bold p-3 border-2 border-pink-200 rounded-2xl outline-none focus:border-pink-500 text-gray-700" placeholder="0"></div>
                <div v-if="currentActivity?.id === 'reading'"><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Okunan Sayfa</label><input type="number" v-model="modalPages" class="w-full text-center text-xl font-bold p-3 border-2 border-orange-200 rounded-xl outline-none focus:border-orange-500 text-orange-600" placeholder="0"></div>
                <p v-if="editingId" class="text-xs text-center text-red-400">Silmek i√ßin s√ºreyi 0 yapƒ±p g√ºncelleyin.</p>
                <button @click="confirmActivity" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg btn-press text-lg mt-4">
                    {{ editingId ? 'G√úNCELLE' : 'KAYDET' }}
                </button>
            </div>
        </div>
    </div>
    
    <!-- Y√ñNETƒ∞Cƒ∞ Gƒ∞Rƒ∞≈û MODALI -->
    <div v-if="showLoginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-3xl w-full max-w-sm relative shadow-2xl animate-bounce-slow">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Y√∂netici Giri≈üi üîê</h3>
            <p class="text-sm text-gray-500 mb-4 text-center">Verileri d√ºzenlemek veya silmek i√ßin ≈üifre girin.</p>
            <input type="password" v-model="loginPassword" placeholder="≈ûifre" class="w-full p-3 border-2 border-gray-200 rounded-xl mb-4 text-center text-lg outline-none focus:border-blue-500">
            <div class="flex gap-2">
                <button @click="showLoginModal = false" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-gray-600">ƒ∞ptal</button>
                <button @click="performLogin" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Giri≈ü Yap</button>
            </div>
        </div>
    </div>

    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="onFileSelected">
</div>

<script>
    // ==========================================
    // YENƒ∞ URL EKLENDƒ∞! ‚úÖ
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpKpdCf40b2ktiUOWZh-JNVJ_Y1bq5MUMF_izdTMdHk6B4dU1cdhcF1P1KUPp6EeFWRg/exec"; 
    // ==========================================

    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
    createApp({
        setup() {
            const loading = ref(false);
            const appTitle = ref(localStorage.getItem('ikra_app_title') || "Buraya adƒ±nƒ±zƒ± giriniz");
            const showWelcome = ref(true);
            const activeTab = ref('rutin');
            const selectedDate = ref(new Date());
            const profileImage = ref(localStorage.getItem('ikra_profile_pic') || null);
            const editMode = ref(false);
            const editingId = ref(null); 
            
            // Y√∂netici √ñzellikleri
            const isAdmin = ref(false);
            const showLoginModal = ref(false);
            const loginPassword = ref('');
            
            const activityLog = ref([]);
            const testRecords = ref([]);
            
            const subjects = ref(JSON.parse(localStorage.getItem('ikra_subjects') || '["T√ºrk√ße", "Matematik", "Hayat Bilgisi", "Fen Bilimleri", "ƒ∞ngilizce"]'));
            const defaultActivities = [
                { id: 'study', label: 'Ders √áalƒ±≈üma', icon: 'fa-clock', color: 'bg-indigo-200' },
                { id: 'reading', label: 'Kitap Okuma', icon: 'fa-book-open', color: 'bg-orange-200' },
                { id: 'saz', label: 'Saz √áalƒ±≈ü', icon: 'fa-music', color: 'bg-yellow-200' },
                { id: 'skate', label: 'Paten S√ºr', icon: 'fa-skating', color: 'bg-blue-200' }
            ];
            const activities = ref(JSON.parse(localStorage.getItem('ikra_activity_list') || JSON.stringify(defaultActivities)));
            const iconOptions = [
                { val: 'fa-clock', label: 'Saat' }, { val: 'fa-book-open', label: 'Kitap A√ßƒ±k' }, 
                { val: 'fa-book', label: 'Kitap Kapalƒ±' }, { val: 'fa-music', label: 'M√ºzik' },
                { val: 'fa-skating', label: 'Paten' }, { val: 'fa-bicycle', label: 'Bisiklet' },
                { val: 'fa-cat', label: 'Kedi' }, { val: 'fa-dog', label: 'K√∂pek' },
                { val: 'fa-palette', label: 'Resim' }, { val: 'fa-comments', label: 'Sohbet' },
                { val: 'fa-utensils', label: 'Yemek' }, { val: 'fa-tv', label: 'TV' },
                { val: 'fa-gamepad', label: 'Oyun' }, { val: 'fa-bed', label: 'Uyku' },
                { val: 'fa-heart', label: 'Kalp' }, { val: 'fa-star', label: 'Yƒ±ldƒ±z' }
            ];
            const showModal = ref(false);
            const currentActivity = ref(null);
            const modalMinutes = ref('');
            const modalPages = ref('');
            const newTest = ref({ subject: 'T√ºrk√ße', total: '', correct: '', empty: '' });
            const chartSubject = ref('all');
            let pieChart = null, lineChart = null;

            const formatDateKey = (d) => d.toLocaleDateString('tr-TR');
            const selectedDateKey = computed(() => formatDateKey(selectedDate.value));
            
            // 0 OLANLARI Gƒ∞ZLE (Sƒ∞Lƒ∞NMƒ∞≈û Gƒ∞Bƒ∞ G√ñSTER)
            // Hem listelerden hem grafiklerden anƒ±nda silinir.
            const dailyActivities = computed(() => activityLog.value.filter(l => l.date === selectedDateKey.value && Number(l.minutes) > 0));
            const dailyTests = computed(() => testRecords.value.filter(t => t.date === selectedDateKey.value && Number(t.total) > 0));
            
            const calculateWrong = computed(() => {
                const total = Number(newTest.value.total) || 0;
                const correct = Number(newTest.value.correct) || 0;
                const empty = Number(newTest.value.empty) || 0;
                const wrong = total - correct - empty;
                return wrong > 0 ? wrong : 0;
            });
            
            // 0 Giri≈üine izin veriyoruz (Silme i√ßin)
            const isValidTest = computed(() => newTest.value.total !== '' && newTest.value.correct !== '' && calculateWrong.value >= 0);
            
            const filteredRecords = computed(() => {
                // Grafikte de 0 olanlarƒ± g√∂sterme
                let recs = testRecords.value.filter(t => Number(t.total) > 0);
                if (chartSubject.value === 'all') return recs;
                return recs.filter(r => r.subject === chartSubject.value);
            });
            const weekDays = computed(() => {
                const curr = new Date(selectedDate.value);
                const day = curr.getDay();
                const diff = curr.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(curr.setDate(diff));
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday); d.setDate(monday.getDate() + i);
                    days.push({ name: d.toLocaleDateString('tr-TR', { weekday: 'short' }), num: d.getDate(), dateObj: new Date(d), dateStr: formatDateKey(d) });
                }
                return days;
            });

            // Watchers - Deep Watch ekledik ki her deƒüi≈üikliƒüi yakalasƒ±n
            watch(appTitle, (val) => localStorage.setItem('ikra_app_title', val));
            watch(activities, (val) => localStorage.setItem('ikra_activity_list', JSON.stringify(val)), { deep: true });
            watch(subjects, (val) => localStorage.setItem('ikra_subjects', JSON.stringify(val)), { deep: true });
            watch([dailyActivities, activeTab], () => { if(activeTab.value === 'rutin') nextTick(renderPieChart); }, { deep: true });
            watch([filteredRecords, activeTab, chartSubject], () => { if(activeTab.value === 'ders') nextTick(renderLineChart); }, { deep: true });

            const toggleEditMode = () => editMode.value = !editMode.value;
            const selectDate = (date) => selectedDate.value = date;
            const changeWeek = (dir) => { const d = new Date(selectedDate.value); d.setDate(d.getDate() + (dir * 7)); selectedDate.value = d; };
            const formatDateDisplay = (date) => date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' });
            const isSelected = (d) => formatDateKey(d) === selectedDateKey.value;
            const onManualDateChange = (e) => { if(e.target.value) selectedDate.value = new Date(e.target.value); };
            const triggerFileUpload = () => document.querySelector('input[type=file]').click();
            const onFileSelected = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { profileImage.value = e.target.result; localStorage.setItem('ikra_profile_pic', e.target.result); };
                    reader.readAsDataURL(file);
                }
            };
            const addNewActivity = () => { activities.value.push({ id: 'act_' + Date.now(), label: 'Yeni', icon: 'fa-star', color: 'bg-gray-200' }); };
            const removeActivity = (index) => { if(confirm('Silmek istiyor musunuz?')) activities.value.splice(index, 1); };
            const addSubject = () => subjects.value.push('Yeni Ders');
            const removeSubject = (index) => { if(confirm('Silmek istiyor musunuz?')) subjects.value.splice(index, 1); };
            
            // Y√ñNETƒ∞Cƒ∞ Gƒ∞Rƒ∞≈ûƒ∞
            const toggleAdminLogin = () => {
                if(isAdmin.value) { isAdmin.value = false; alert("Y√∂netici √ßƒ±kƒ±≈üƒ± yapƒ±ldƒ±."); } 
                else { showLoginModal.value = true; }
            };
            const performLogin = () => {
                if(loginPassword.value === '1234') { 
                    isAdmin.value = true; showLoginModal.value = false; loginPassword.value = ''; alert("Y√∂netici giri≈üi ba≈üarƒ±lƒ±!"); 
                } else { alert("Hatalƒ± ≈üifre!"); }
            };

            // GOOGLE API
            const fetchDataFromGoogle = async () => {
                if(!GOOGLE_SCRIPT_URL) return;
                loading.value = true;
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL);
                    const data = await res.json();
                    
                    // BURADA TEMƒ∞ZLƒ∞K YAPIYORUZ: 0 veya ge√ßersiz olanlarƒ± listeye hi√ß alma
                    activityLog.value = data.filter(item => item.dataType === 'activity' && Number(item.minutes) > 0);
                    testRecords.value = data.filter(item => item.dataType === 'test' && Number(item.total) > 0);
                    
                } catch(err) { console.error(err); } 
                finally { loading.value = false; nextTick(() => { if(activeTab.value === 'rutin') renderPieChart(); if(activeTab.value === 'ders') renderLineChart(); }); }
            };

            const sendDataToGoogle = async (payload) => {
                if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === "BURAYA_YAPISTIR") { 
                    alert("L√ºtfen Google Script URL'nizi index.html dosyasƒ±nƒ±n i√ßine yapƒ±≈ütƒ±rƒ±n!"); 
                    return; 
                }
                loading.value = true;
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST", mode: "no-cors",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(payload)
                    });
                } catch(err) { alert("Sunucu hatasƒ±!"); } 
                finally { loading.value = false; }
            };

            // D√úZENLEME VE Sƒ∞LME FONKSƒ∞YONLARI
            const deleteLog = async (id, type) => {
                // Bu fonksiyon artƒ±k kullanƒ±lmƒ±yor olabilir ama eski uyumluluk i√ßin bƒ±rakƒ±yoruz
                // Artƒ±k silme i≈üini "Edit -> 0 Yap -> Kaydet" y√∂ntemiyle yapƒ±yoruz
                if(!confirm('Kalƒ±cƒ± olarak silmek istiyor musunuz?')) return;
                
                // Ekrandan sil (Hƒ±zlƒ± geri bildirim)
                if(type === 'activity') activityLog.value = activityLog.value.filter(x => x.id !== id);
                else testRecords.value = testRecords.value.filter(x => x.id !== id);
                
                // Sunucuya g√∂nder
                await sendDataToGoogle({ dataType: 'delete', deleteId: id });
                
                nextTick(() => { if(activeTab.value === 'rutin') renderPieChart(); if(activeTab.value === 'ders') renderLineChart(); });
            };

            const editLog = (item, type) => {
                editingId.value = item.id;
                
                if (type.includes('delete')) {
                    // Silme (Sƒ±fƒ±rlama) Modu
                    if(!confirm("Bu kaydƒ± silmek i√ßin deƒüerlerini 0 yaparak g√ºncellemek ister misiniz?")) {
                        editingId.value = null; return;
                    }
                }
                
                if(type.startsWith('activity')) {
                    const actDef = activities.value.find(a => a.id === item.type);
                    currentActivity.value = actDef || { icon: 'fa-star', label: 'Bilinmeyen' };
                    modalMinutes.value = type.includes('delete') ? 0 : item.minutes;
                    modalPages.value = type.includes('delete') ? 0 : item.pages;
                    showModal.value = true;
                    if(type.includes('delete')) confirmActivity(); // Otomatik onayla
                } else {
                    newTest.value = {
                        subject: item.subject,
                        total: type.includes('delete') ? 0 : item.total,
                        correct: type.includes('delete') ? 0 : item.correct,
                        empty: type.includes('delete') ? 0 : item.empty
                    };
                    if(type.includes('delete')) {
                        saveTest(); // Otomatik onayla
                    } else {
                        document.querySelector('header').scrollIntoView({ behavior: 'smooth' });
                    }
                }
            };

            const cancelEdit = () => {
                editingId.value = null;
                newTest.value = { subject: 'T√ºrk√ße', total: '', correct: '', empty: '' };
            };

            const openActivityModal = (act) => { 
                if(editMode.value) return; 
                editingId.value = null; // Yeni kayƒ±t
                currentActivity.value = act; modalMinutes.value = ''; modalPages.value = ''; showModal.value = true; 
            };
            
            const confirmActivity = () => {
                if(modalMinutes.value === '') return; // Bo≈ü olamaz ama 0 olabilir
                const payload = { 
                    id: editingId.value || Date.now(), 
                    type: currentActivity.value.id, 
                    minutes: Number(modalMinutes.value), 
                    pages: Number(modalPages.value) || 0, 
                    date: selectedDateKey.value,
                    dataType: 'activity' // G√ºncelleme olsa da veri tipi activity
                };
                
                if(editingId.value) {
                     // G√ºncelleme: Listeden eskisini bul deƒüi≈ütir
                     const idx = activityLog.value.findIndex(x => x.id === editingId.value);
                     if(idx !== -1) activityLog.value[idx] = payload;
                     payload.dataType = 'update'; // Script'e update emri
                } else {
                     // Yeni kayƒ±t
                     activityLog.value.push(payload);
                }
                
                sendDataToGoogle(payload);
                showModal.value = false;
                editingId.value = null;
            };

            const saveTest = () => {
                if(!isValidTest.value) return;
                const payload = { 
                    id: editingId.value || Date.now(), 
                    subject: newTest.value.subject, 
                    total: Number(newTest.value.total), 
                    correct: Number(newTest.value.correct), 
                    empty: Number(newTest.value.empty) || 0, 
                    wrong: calculateWrong.value, 
                    date: selectedDateKey.value, 
                    isoDate: selectedDate.value.toISOString(),
                    dataType: 'test'
                };
                
                if(editingId.value) {
                    const idx = testRecords.value.findIndex(x => x.id === editingId.value);
                    if(idx !== -1) testRecords.value[idx] = payload;
                    payload.dataType = 'update';
                } else {
                    testRecords.value.push(payload);
                }
                
                sendDataToGoogle(payload);
                newTest.value.correct = ''; newTest.value.empty = '';
                editingId.value = null;
            };
            
            // Grafik ve Yardƒ±mcƒ±lar
            const getDayActivityTotal = (actId) => dailyActivities.value.filter(x => x.type === actId).reduce((sum, x) => sum + x.minutes, 0);
            const getActivityLabel = (id) => activities.value.find(a => a.id === id)?.label || 'Bilinmeyen';
            const getActivityIcon = (id) => activities.value.find(a => a.id === id)?.icon || 'fa-star';

            const renderPieChart = () => {
                const ctx = document.getElementById('rutinChart');
                if(!ctx) return; if(pieChart) pieChart.destroy();
                const summary = {}; dailyActivities.value.forEach(x => { summary[x.type] = (summary[x.type] || 0) + x.minutes; });
                const labels = Object.keys(summary).map(k => getActivityLabel(k)); const data = Object.values(summary);
                const colors = ['#FFCDD2', '#F8BBD0', '#E1BEE7', '#D1C4E9', '#C5CAE9', '#BBDEFB', '#B3E5FC', '#B2EBF2', '#B2DFDB', '#C8E6C9'];
                pieChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } } });
            };
            const renderLineChart = () => {
                const ctx = document.getElementById('dersChart');
                if(!ctx) return; 
                if(lineChart) lineChart.destroy();
                
                // Filtrelenmi≈ü veri yoksa (veya hepsi 0 ise) bo≈ü bƒ±rak
                if (filteredRecords.value.length === 0) return;

                const sorted = [...filteredRecords.value].sort((a,b) => new Date(a.isoDate) - new Date(b.isoDate)); const last10 = sorted.slice(-10);
                const labels = last10.map(x => x.date.substring(0, 5)); const data = last10.map(x => (x.correct / x.total) * 100);
                lineChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Ba≈üarƒ± Y√ºzdesi (%)', data: data, borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } } });
            };

            onMounted(() => { fetchDataFromGoogle(); });

            return {
                loading, appTitle, showWelcome, activeTab, selectedDate, profileImage, editMode,
                isAdmin, showLoginModal, loginPassword, toggleAdminLogin, performLogin, deleteLog, editLog,
                editingId, cancelEdit,
                weekDays, changeWeek, selectDate, isSelected, formatDateDisplay,
                activities, subjects, iconOptions, activityLog, testRecords, dailyActivities, dailyTests,
                triggerFileUpload, onFileSelected, addNewActivity, removeActivity, addSubject, removeSubject,
                showModal, openActivityModal, currentActivity, modalMinutes, modalPages, confirmActivity,
                getDayActivityTotal, getActivityLabel, getActivityIcon,
                newTest, calculateWrong, isValidTest, saveTest, toggleEditMode,
                chartSubject, filteredRecords, onManualDateChange
            };
        }
    }).mount('#app');
</script>
</body>
</html>
